<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>controllers/user.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Attachment_Controller.html">Attachment_Controller</a><ul class='methods'><li data-type='method'><a href="Attachment_Controller.html#getAttachment">getAttachment</a></li><li data-type='method'><a href="Attachment_Controller.html#getAttachmentUrl">getAttachmentUrl</a></li></ul></li><li><a href="Bot_Controller.html">Bot_Controller</a><ul class='methods'><li data-type='method'><a href="Bot_Controller.html#processEvent">processEvent</a></li></ul></li><li><a href="Facebook_Controller.html">Facebook_Controller</a><ul class='methods'><li data-type='method'><a href="Facebook_Controller.html#setGreetingText">setGreetingText</a></li></ul></li><li><a href="Menu_Controller.html">Menu_Controller</a><ul class='methods'><li data-type='method'><a href="Menu_Controller.html#getFacebookButtons">getFacebookButtons</a></li><li data-type='method'><a href="Menu_Controller.html#getFacebookMenu">getFacebookMenu</a></li><li data-type='method'><a href="Menu_Controller.html#getMenu">getMenu</a></li></ul></li><li><a href="NGINB.html">NGINB</a><ul class='methods'><li data-type='method'><a href="NGINB.html#addEventListener">addEventListener</a></li><li data-type='method'><a href="NGINB.html#configure">configure</a></li><li data-type='method'><a href="NGINB.html#dispatchEvent">dispatchEvent</a></li><li data-type='method'><a href="NGINB.html#getBotController">getBotController</a></li><li data-type='method'><a href="NGINB.html#getBotResponse">getBotResponse</a></li><li data-type='method'><a href="NGINB.html#getFacebookController">getFacebookController</a></li><li data-type='method'><a href="NGINB.html#getMenuController">getMenuController</a></li><li data-type='method'><a href="NGINB.html#getPageController">getPageController</a></li><li data-type='method'><a href="NGINB.html#getUserController">getUserController</a></li><li data-type='method'><a href="NGINB.html#sendMessengeEvent">sendMessengeEvent</a></li><li data-type='method'><a href="NGINB.html#setEntities">setEntities</a></li></ul></li><li><a href="Page_Controller.html">Page_Controller</a><ul class='methods'><li data-type='method'><a href="Page_Controller.html#getFacebookPageByLanguage">getFacebookPageByLanguage</a></li><li data-type='method'><a href="Page_Controller.html#getFacebookPageInfo">getFacebookPageInfo</a></li><li data-type='method'><a href="Page_Controller.html#getFacebookPageLanguage">getFacebookPageLanguage</a></li><li data-type='method'><a href="Page_Controller.html#getFacebookPageToken">getFacebookPageToken</a></li><li data-type='method'><a href="Page_Controller.html#isValidPage">isValidPage</a></li></ul></li><li><a href="User_Controller.html">User_Controller</a><ul class='methods'><li data-type='method'><a href="User_Controller.html#addUser">addUser</a></li><li data-type='method'><a href="User_Controller.html#getNewUser">getNewUser</a></li><li data-type='method'><a href="User_Controller.html#getUser">getUser</a></li><li data-type='method'><a href="User_Controller.html#getUserByName">getUserByName</a></li><li data-type='method'><a href="User_Controller.html#getUserData">getUserData</a></li><li data-type='method'><a href="User_Controller.html#getUsers">getUsers</a></li><li data-type='method'><a href="User_Controller.html#updateUser">updateUser</a></li></ul></li></ul><h3>Mixins</h3><ul><li><a href="Rivescript_Tags.html">Rivescript_Tags</a></li></ul><h3>Global</h3><ul><li><a href="global.html#Bot">Bot</a></li><li><a href="global.html#BotConfig">BotConfig</a></li><li><a href="global.html#DatabaseConfig">DatabaseConfig</a></li><li><a href="global.html#DispatcherConfig">DispatcherConfig</a></li><li><a href="global.html#EntityConfig">EntityConfig</a></li><li><a href="global.html#Event">Event</a></li><li><a href="global.html#FacebookConfig">FacebookConfig</a></li><li><a href="global.html#Options">Options</a></li><li><a href="global.html#PageConfig">PageConfig</a></li><li><a href="global.html#PageObjectConfig">PageObjectConfig</a></li><li><a href="global.html#UserResponse">UserResponse</a></li><li><a href="global.html#UserUpdateResponse">UserUpdateResponse</a></li><li><a href="global.html#WordConfig">WordConfig</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">controllers/user.js</h1>
    

    



    
<section>
    <article>
        <pre class="prettyprint source linenums"><code>var promise 		= require('bluebird');
var JSONbig 		= require('json-bigint');
var botconfig 		= require('../config/botconfig');
var usermodel 		= require('../models/user')(botconfig.database.config);
var customuserctl 	= false;
var facebookctl 	= false;

exports = module.exports = function(facebookcontroller, customusercontroller)
{
	return new Userctl(facebookcontroller, customusercontroller);
}

/**
 * @constructs User_Controller
 * @public
 * @param {Object} facebookcontroller - A NGINB facebook controller
 * @param {Object} customusercontroller - A custom user controller - {@link https://github.com/tostegroo/rivescript-nginb-js/blob/master/template-files/userctl.js|template}
 */
function Userctl(facebookcontroller, customusercontroller)
{
	this.user_cache = {};

	customuserctl = customusercontroller || false;
	facebookctl = facebookcontroller || false;
}

/**
 * Gets the user data from bot local user data plus custom user data
 * @param {String} sender_id - The facebook sender id
 * @param {PageConfig} page - A PageConfig object
 * @param {String} lang - The language of the menu for multilanguage menus
 * @return {Object|Boolean} A bluebird promise response object with user data or false if none
 */
Userctl.prototype.getUserData = function getUserData(sender_id, page, lang)
{
	var self = this;
	return new promise(function(resolve, reject)
	{
		self.getUser(sender_id, page)
		.then(function(user_response)
		{
			if(user_response)
			{
				if(customuserctl!=false &amp;&amp; customuserctl.getUserData!=undefined)
				{
					customuserctl.getUserData(user_response, sender_id, page, lang)
					.then(function(final_user_response)
					{
						resolve(final_user_response);
					});
				}
				else
					resolve(user_response);
			}
			else
				resolve(false);
		});
	});
}

/**
 * Gets the user data from bot local user data
 * @param {String} sender_id - The facebook sender id
 * @param {PageConfig} page - A PageConfig object
 * @return {Object|Boolean} A bluebird promise response object with user data or false if none
 */
Userctl.prototype.getUser = function getUser(sender_id, page)
{
	var self = this;
	return new promise(function(resolve, reject)
	{
		if(usermodel)
		{
			usermodel.getUser(sender_id)
			.then(function(user)
			{
				if(user)
					resolve(user);
				else
				{
					self.addUser(sender_id, page)
					.then(function(new_user)
					{
						if(new_user.response)
							resolve(new_user.response);
						else
						{
							if(self.user_cache[sender_id]==undefined)
								self.user_cache[sender_id] = new_user.data;

							resolve(self.user_cache[sender_id]);
						}
					});
				}
			});
		}
		else
			resolve(false);
	});
}

/**
 * Gets the user data from bot local user data by a given name
 * @param {String} name - The name of the user
 * @return {Object|Boolean} A bluebird promise response object with user data or false if none
 */
Userctl.prototype.getUserByName = function getUsers(name)
{
	var self = this;
	return new promise(function(resolve, reject)
	{
		if(usermodel)
		{
			usermodel.getUserByName(name)
			.then(function(user)
			{
				if(user)
				{
					if(user.length!=undefined)
						resolve(user[0]);
					else
						resolve(user);
				}
				else
				{
					var curr_user = false;
					for (var key in self.user_cache)
					{
						var user = self.user_cache[key];
						if(user.first_name.toLowerCase()==name.toLowerCase() || user.last_name.toLowerCase()==name.toLowerCase())
						{
							curr_user = user;
							break;
						}
					}

					resolve(curr_user);
				}
			});
		}
		else
			resolve(false);
	});
}

/**
 * Adds an user by a given data set
 * @param {String} sender_id - The facebook sender id
 * @param {PageConfig} page - A PageConfig object
 * @param {Object} data - The data object with pairs of key values to add to user data
 * @return {UserResponse} A bluebird promise response user object with user data
 */
Userctl.prototype.addUser = function addUser(sender_id, page, data)
{
	var self = this;
	return new promise(function(resolve, reject)
	{
		if((!data || data==undefined) &amp;&amp; page!=undefined)
		{
			if(facebookctl)
			{
				facebookctl.requestUserData(page, sender_id)
				.then(function(response)
				{
					var facebook_data = {};

					if(response.hasOwnProperty('data') &amp;&amp; response.data.hasOwnProperty('body') &amp;&amp; !response.data.body.hasOwnProperty('error'))
							facebook_data = response.data.body;

					if(typeof(facebook_data)=='string')
						facebook_data = JSONbig.parse(facebook_data);

					facebook_data.status = 1;

					if(botconfig.botconfig.use_permanent_bot_user)
					{
						facebook_data.page_id = page.id;
						facebook_data.sender_id = sender_id;

						usermodel.addUser(facebook_data)
						.then(function(user)
						{
							if(user &amp;&amp; user.affectedRows!=undefined &amp;&amp; user.affectedRows>0)
							{
								userctl.getNewUser(facebook_data)
								.then(function(new_user)
								{
									resolve({response:new_user, data:facebook_data});
								});
							}
							else
								resolve({response:user, data:facebook_data});
						});
					}
					else
						resolve({response:false, data:facebook_data});
				});
			}
			else
				resolve({response:false, data:{}});
		}
		else if(data)
		{
			data.sender_id = sender_id;

			if(usermodel)
			{
				usermodel.addUser(data)
				.then(function(user)
				{
					if(user &amp;&amp; user.affectedRows!=undefined &amp;&amp; user.affectedRows>0)
					{
						userctl.getNewUser(data)
						.then(function(new_user)
						{
							resolve({response:new_user, data:data});
						});
					}
					else
						resolve({response:user, data:data});
				});
			}
			else
				resolve({response:false, data:false});
		}
		else
			resolve({response:false, data:false});
	});
}

/**
 * Gets the user from database
 * @param {Object} data - The data object with at least sender id key on it
 * @return {Object|Boolean} A bluebird promise mysql object with user data or false if none
 */
Userctl.prototype.getNewUser = function getNewUser(data)
{
	var self = this;
	return new promise(function(resolve, reject)
	{
		if(usermodel)
		{
			usermodel.getUser(data.sender_id)
			.then(function(user)
			{
				resolve(user);
			});
		}
		else
			resolve(false);
	});
}

/**
 * Updates an user by a given data set
 * @param {String} sender_id - The facebook sender id
 * @param {Object} data - The data object with pairs of key values to update user data
 * @return {UserUpdateResponse} A bluebird promise response user object with user data
 */
Userctl.prototype.updateUser = function updateUser(sender_id, data)
{
	var self = this;
	return new promise(function(resolve, reject)
	{
		if(usermodel)
		{
			usermodel.updateUser(sender_id, data)
			.then(function(user)
			{
				if(user &amp;&amp; user.hasOwnProperty('affectedRows') &amp;&amp; user.affectedRows>0)
					resolve({status:true, data:user});
				else
				{
					if(self.user_cache[sender_id]!=undefined)
					{
						for (var k in data)
						{
							if (data.hasOwnProperty(k) &amp;&amp; self.user_cache[sender_id].hasOwnProperty(k))
								self.user_cache[sender_id][k] = data[k];
						}

						resolve({status:true, data:self.user_cache[sender_id]});
					}
					else
						resolve({status:false, data:false});
				}
			});
		}
		else
			resolve({response:false, data:false});
	});
}

/**
 * Gets the list of all the users, paged from 20 by 20
 * @param {Numner} page - The page of the list
 * @return {Object} A bluebird promise response user object with the list of users
 */
Userctl.prototype.getUsers = function getUsers(page)
{
	var self = this;
	return new promise(function(resolve, reject)
	{
		var ppg = 20;
		page = (page&lt;1) ? 1 : page;
        page = (page-1) * ppg;

		if(usermodel)
		{
			usermodel.getUserCount()
	        .then(function(response)
			{
				if(response&amp;&amp;response.count)
	            {
	                page = response.count&lt;ppg ? 0 : page;

					usermodel.getUsers(page, ppg)
					.then(function(userlist)
					{
						var totalpage = 0;
						if(userlist)
						{
							if(userlist.length==undefined)
								userlist = [userlist]

							resolve({total_count:response.count, page_count:userlist.length, entries:userlist});
						}
						else
						{
							totalpage = self.user_cache.length!=undefined ? self.user_cache.length : 0;
							resolve({total_count:response.count, page_count:totalpage, entries:self.user_cache});
						}

					});
	            }
	            else
	                resolve(false);
			});
		}
		else
			resolve(false);
	});
}
</code></pre>
    </article>
</section>





</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Sun Mar 26 2017 18:41:56 GMT-0300 (E. South America Standard Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
